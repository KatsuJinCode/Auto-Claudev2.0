{
  "description": "Modularize Core Infrastructure and Achieve Full Test Suite Coverage - Fix 13 oversized files blocking tests, complete breath stream feature, achieve 491+ passing tests",
  "workflow_type": "refactor",
  "phases": [
    {
      "name": "Modularize Oversized Files - Priority 1",
      "description": "Break down the largest files blocking test suite",
      "chunks": [
        {
          "description": "Refactor tools/agent_service.py (106KB) into agent_lifecycle.py, agent_communication.py, registry_manager.py modules in lib/agent_service/",
          "files": ["lib/agent_service/__init__.py", "lib/agent_service/agent_lifecycle.py", "lib/agent_service/agent_communication.py", "lib/agent_service/registry_manager.py", "tools/agent_service.py"],
          "verification": "agent_service.py reduced below 50KB, all imports still work"
        },
        {
          "description": "Refactor dev/knowledge_engine_core.py (89KB) into cache_layer.py, gatekeeper.py, vector_search.py, synthesis.py in lib/knowledge_engine/",
          "files": ["lib/knowledge_engine/__init__.py", "lib/knowledge_engine/cache_layer.py", "lib/knowledge_engine/gatekeeper.py", "lib/knowledge_engine/vector_search.py", "lib/knowledge_engine/synthesis.py", "dev/knowledge_engine_core.py"],
          "verification": "knowledge_engine_core.py reduced below 50KB, Oracle retrieval still works"
        }
      ]
    },
    {
      "name": "Modularize Oversized Files - Priority 2",
      "description": "Continue breaking down oversized dashboard and module files",
      "depends_on": [1],
      "chunks": [
        {
          "description": "Refactor tools/dashboard/app.py and screens_*.py - extract screen logic into separate module files in tools/dashboard/screens/",
          "files": ["tools/dashboard/screens/__init__.py", "tools/dashboard/screens/screen_project.py", "tools/dashboard/screens/screen_background.py", "tools/dashboard/screens/screen_network.py", "tools/dashboard/app.py"],
          "verification": "Dashboard files each under size limit, dashboard still launches"
        },
        {
          "description": "Refactor modules/kamala/database.py and semantic_chunker.py - extract core algorithms into chunking_algorithms.py, semantic_utils.py",
          "files": ["modules/kamala/chunking_algorithms.py", "modules/kamala/semantic_utils.py", "modules/kamala/database.py", "modules/kamala/semantic_chunker.py"],
          "verification": "Kamala module files under size limit, chunking still works"
        },
        {
          "description": "Refactor tools/architect.py, architect_router.py, validation_pipeline.py, llm_validator.py, web_dashboard.py into smaller modules",
          "files": ["tools/architect/__init__.py", "tools/architect/route_handler.py", "tools/architect/graph_search.py", "tools/architect/query_engine.py", "tools/architect.py", "tools/architect_router.py"],
          "verification": "All architect files under size limit"
        }
      ]
    },
    {
      "name": "Complete Breath Stream Feature",
      "description": "Fix agent output relay for real-time dashboard updates",
      "depends_on": [1],
      "chunks": [
        {
          "description": "Diagnose and fix test_run_claude_creates_breath_stream and related test failures - implement streaming output pipes between agent_service and dashboard",
          "files": ["tools/agent_service.py", "tests/unit/test_agent_hub.py"],
          "verification": "test_run_claude_creates_breath_stream passes"
        },
        {
          "description": "Wire output capture in agent_service.py to dashboard background task - ensure real-time transcript updates flow without buffering",
          "files": ["tools/agent_service.py", "tools/dashboard/app.py"],
          "verification": "Agent output appears in dashboard in real-time during execution"
        }
      ]
    },
    {
      "name": "Fix Registry and Validate Tests",
      "description": "Fix remaining test failures and validate full suite",
      "depends_on": [2, 3],
      "chunks": [
        {
          "description": "Debug and fix test_reset_succeeds_with_force failure in registry tests - ensure module state transitions properly with force flag",
          "files": ["tests/unit/test_registry_manager.py", "lib/agent_service/registry_manager.py"],
          "verification": "test_reset_succeeds_with_force passes"
        },
        {
          "description": "Run full pytest suite, verify all 491+ tests pass with no failures or skips, document any edge cases",
          "files": ["tests/unit/conftest.py"],
          "verification": "pytest tests/unit -v shows 491+ passing, 0 failures"
        }
      ]
    },
    {
      "name": "Cleanup and Documentation",
      "description": "Clean artifacts and update tracking",
      "depends_on": [4],
      "chunks": [
        {
          "description": "Verify all temporary/test files cleaned, confirm .trash/ and .archive/ contain expected backups, update WORK_TRACKING.md with completion status",
          "files": ["WORK_TRACKING.md"],
          "verification": "No orphan temp files, tracking updated"
        }
      ]
    }
  ]
}
